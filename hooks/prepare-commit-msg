#!/bin/sh

# This script is a Git hook that generates a commit message using the `aigitcommit` command.
# It is triggered before the commit message editor is opened.
# Usage: Place this script in the `.git/hooks/` directory of your repository and make it executable.
COMMIT_MSG_FILE=$1
COMMIT_MSG_TYPE=$2
REPO_ROOT=$(git rev-parse --show-toplevel)

# Check the repository root directory is valid
# The `git rev-parse --show-toplevel` command returns the absolute path to the root of the repository
# If the command fails, it means we are not in a Git repository
if [ ! -d "$REPO_ROOT" ]; then
    echo "Error: Repository root not found."
    exit 1
fi

# Check if aigitcommit is installed
if ! type aigitcommit >/dev/null 2>&1; then
    echo "Error: aigitcommit is not installed. Please install it first."
    exit 0
fi

# Only run for interactive commits or explicit empty messages
RUN_EDITOR=0
if [ -n "$COMMIT_MSG_TYPE" ]; then
    if [ "$COMMIT_MSG_TYPE" != "message" ]; then
        exit 0
    fi

    # For `git commit -m ""` we still want to generate a message and open the editor
    if grep -Eq '^[[:space:]]*[^#[:space:]]' "$COMMIT_MSG_FILE"; then
        exit 0
    fi
    RUN_EDITOR=1
else
    # Plain `git commit`: always run AIGitCommit regardless of template content
    :
fi

# Get only the diff of what has already been staged
GIT_DIFF_OUTPUT=$(git diff --cached)

# Check if there are any staged changes to commit
if [ -z "$GIT_DIFF_OUTPUT" ]; then
    echo "No staged changes detected. Aborting."
    exit 1
fi

# Generate a temporary file for the commit message
TEMP_FILE=$(mktemp)

# Execute aigitcommit to generate the commit message and append existing content
echo "ðŸš€ Generating commit message by using aigitcommit."
echo "This may take a few seconds..."
aigitcommit "$REPO_ROOT" --save "$TEMP_FILE" >/dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "Error: aigitcommit failed to generate commit message."
    rm -f "$TEMP_FILE"
    exit 1
fi

cat "$COMMIT_MSG_FILE" >>"$TEMP_FILE" && mv -f "$TEMP_FILE" "$COMMIT_MSG_FILE"

# When the commit was started with `git commit -m ""`, invoke the editor manually
if [ "$RUN_EDITOR" -eq 1 ]; then
    EDITOR_CMD=$(git var GIT_EDITOR 2>/dev/null)
    if [ -z "$EDITOR_CMD" ]; then
        if [ -n "$VISUAL" ]; then
            EDITOR_CMD="$VISUAL"
        elif [ -n "$EDITOR" ]; then
            EDITOR_CMD="$EDITOR"
        else
            EDITOR_CMD="vi"
        fi
    fi

    # shellcheck disable=SC2086 -- intentional word splitting to respect editor arguments
    $EDITOR_CMD "$COMMIT_MSG_FILE"
fi
